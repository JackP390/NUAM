{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Consola de Administraci√≥n | Nuam</title>
    <link rel="stylesheet" href="{% static 'css/admin.css' %}">
    <link rel="stylesheet" href="{% static 'css/holder.css' %}"> 
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header">
            <img src="{% static 'images/Nuam_logo-transparente.png' %}" alt="Nuam Admin" class="sidebar-logo">
        </div>
        
        <ul class="nav-links">
            <li class="nav-item active" onclick="showSection('corredores', this)">
                <span>üë§ Corredores</span>
            </li>
            <li class="nav-item" onclick="showSection('emisores', this)">
                <span>üè¢ Emisores</span>
            </li>
            <li class="nav-item" onclick="showSection('clientes_global', this)">
                <span>üë• Clientes Globales</span>
            </li>
            <li class="nav-item" onclick="showSection('calificaciones', this)">
                <span>üìä Calificaciones</span>
            </li>
        </ul>

        <div class="logout-link">
            <a href="{% url 'main' %}">‚Üê Volver al Inicio</a>
        </div>
    </nav>

    <main class="main-content">
        
        {% if messages %}
        <div style="margin-bottom: 20px;">
            {% for message in messages %}
                <div style="padding: 15px; background: #fff; border-left: 5px solid #ff4403; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
        {% endif %}

        <div id="corredores" class="section-container active-section">
            <div class="card">
                <h2>Gesti√≥n de Corredores</h2>
                <p>Administra el acceso de los usuarios al sistema.</p>
                <table class="info">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Estado</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in corredores %}
                        <tr>
                            <td>{{ c.nombre }}</td>
                            <td>{{ c.email }}</td>
                            <td>
                                {% if c.is_active %}
                                    <span class="status-active">Activo</span>
                                {% else %}
                                    <span class="status-inactive">Inactivo</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if c.email != request.user.email %}
                                    <a href="{% url 'toggle_status_corredor' c.id %}" class="btn-toggle">
                                        {% if c.is_active %}Desactivar{% else %}Activar{% endif %}
                                    </a>
                                {% else %}
                                    <small style="color:#aaa;">(Tu cuenta)</small>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="emisores" class="section-container">
            <div class="card">
                <h2>Crear Nuevo Emisor</h2>
                <form action="{% url 'create_emisor' %}" method="POST" style="display: flex; gap: 10px; align-items: center; margin-bottom: 30px;">
                    {% csrf_token %}
                    {{ form_emisor.rut }}
                    {{ form_emisor.nombre }}
                    <button type="submit" id="boton" style="margin:0; width: auto; padding: 10px 20px;">+ A√±adir</button>
                </form>
            </div>

            <div class="card">
                <h2>Listado de Emisores</h2>
                <table class="info">
                    <thead>
                        <tr>
                            <th>RUT</th>
                            <th>Raz√≥n Social</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for e in emisores %}
                        <tr>
                            <td>{{ e.rut }}</td>
                            <td>{{ e.nombre }}</td>
                            <td>
                                <span class="{% if e.estado %}status-active{% else %}status-inactive{% endif %}">
                                    {{ e.estado|yesno:"Activo,Inactivo" }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="clientes_global" class="section-container">
            <div class="card">
                <h2>Listado Global de Clientes</h2>
                <p>Visualizaci√≥n de todos los clientes registrados por los corredores.</p>
                <table class="info">
                    <thead>
                        <tr>
                            <th>RUT</th>
                            <th>Nombre</th>
                            <th>Corredor Asignado</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cl in clientes %}
                        <tr>
                            <td>{{ cl.rut }}</td>
                            <td>{{ cl.nombre }}</td>
                            <td>{{ cl.corredor.nombre }}</td> <td>
                                <form method="POST" action="{% url 'delete_any_client' cl.id %}" onsubmit="return confirm('¬øSeguro que desea eliminar este cliente?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-toggle" style="background:#ffcccc; color:red; border:none; cursor:pointer;">Eliminar</button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4">No hay clientes registrados.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="calificaciones" class="section-container">
            <div class="card">
                <h2>Carga Masiva de Calificaciones</h2>
                <p>Sube un archivo <strong>.CSV</strong> para importar calificaciones tributarias masivamente.</p>
                <div style="background: #fff3e0; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #ffe0b2;">
                    <strong>Formato requerido:</strong><br>
                    Columna 1: RUT Cliente <br>
                    Columna 2: RUT Emisor <br>
                    Columna 3: A√±o Tributario
                </div>

                <form action="{% url 'carga_masiva' %}" method="POST" enctype="multipart/form-data" style="text-align: center; border: 2px dashed #ccc; padding: 40px; border-radius: 10px;">
                    {% csrf_token %}
                    <input type="file" name="archivo_csv" accept=".csv" required style="margin-bottom: 20px;">
                    <br>
                    <button type="submit" id="boton" style="width: auto; padding: 10px 30px;">Procesar Archivo</button>
                </form>
            </div>
        </div>

    </main>

    <script>
        function showSection(sectionId, element) {
            // 1. Ocultar todas las secciones
            document.querySelectorAll('.section-container').forEach(div => {
                div.classList.remove('active-section');
            });

            // 2. Desactivar todos los botones del men√∫
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // 3. Mostrar la secci√≥n seleccionada
            document.getElementById(sectionId).classList.add('active-section');

            // 4. Activar el bot√≥n presionado
            element.classList.add('active');
        }
    </script>

</body>
</html>